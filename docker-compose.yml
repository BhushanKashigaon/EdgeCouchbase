version: '3.8'

services:
  # Node 1 - Data + Query services
  node1:
    build:
      context: .
      dockerfile: deploy/docker/Dockerfile.node
    container_name: edgecb-node1
    hostname: node1
    ports:
      - "11210:11210"  # Data service
      - "8093:8093"    # Query service
      - "8091:8091"    # Admin API
    environment:
      - NODE_ID=node1
      - CLUSTER_NAME=dev-cluster
      - SERVICES=data,query,admin
      - MEMORY_QUOTA=512
    volumes:
      - node1-data:/data
    networks:
      - edgecb-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8091/health"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s

  # Node 2 - Data + Index services
  node2:
    build:
      context: .
      dockerfile: deploy/docker/Dockerfile.node
    container_name: edgecb-node2
    hostname: node2
    ports:
      - "11211:11210"
      - "9102:9102"    # Index service
      - "8092:8091"
    environment:
      - NODE_ID=node2
      - CLUSTER_NAME=dev-cluster
      - SERVICES=data,index,admin
      - MEMORY_QUOTA=512
      - JOIN_NODE=node1:8091
    volumes:
      - node2-data:/data
    networks:
      - edgecb-network
    depends_on:
      node1:
        condition: service_healthy

  # Node 3 - Data + Search services  
  node3:
    build:
      context: .
      dockerfile: deploy/docker/Dockerfile.node
    container_name: edgecb-node3
    hostname: node3
    ports:
      - "11212:11210"
      - "8094:8094"    # Search service
      - "8090:8091"
    environment:
      - NODE_ID=node3
      - CLUSTER_NAME=dev-cluster
      - SERVICES=data,search,admin
      - MEMORY_QUOTA=512
      - JOIN_NODE=node1:8091
    volumes:
      - node3-data:/data
    networks:
      - edgecb-network
    depends_on:
      node1:
        condition: service_healthy

volumes:
  node1-data:
  node2-data:
  node3-data:

networks:
  edgecb-network:
    driver: bridge
